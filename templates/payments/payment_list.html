{% extends 'base.html' %}

{% block title %}Gestion des Paiements - Admin - Festy Event{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
    <div>
        <h1><i class="fas fa-credit-card"></i> Supervision des Paiements</h1>
        <p style="color: var(--text-gray); margin-bottom: 0;">Suivi et monitoring des transactions clients</p>
    </div>
</div>

<!-- Statistiques -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
    <div class="card">
        <h3 style="color: #10b981; margin-bottom: 0.5rem;">{{ total_amount|floatformat:3 }} TND</h3>
        <p style="color: var(--text-gray);">Total encaissé</p>
    </div>
    <div class="card">
        <h3 style="color: #fbbf24; margin-bottom: 0.5rem;">{{ pending_count }}</h3>
        <p style="color: var(--text-gray);">En attente</p>
    </div>
    <div class="card">
        <h3 style="color: #10b981; margin-bottom: 0.5rem;">{{ completed_count }}</h3>
        <p style="color: var(--text-gray);">Complétés</p>
    </div>
    <div class="card">
        <h3 style="color: #e74c3c; margin-bottom: 0.5rem;">{{ failed_count }}</h3>
        <p style="color: var(--text-gray);">Échoués</p>
    </div>
</div>

<!-- Filtres -->
<div class="card" style="margin-bottom: 1.5rem;">
    <h3 style="margin-bottom: 1rem;"><i class="fas fa-filter"></i> Filtres</h3>
    <form method="get" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;">
        <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                <i class="fas fa-info-circle"></i> Statut
            </label>
            <select name="status" class="filter-select" onchange="this.form.submit()">
                <option value="">Tous les statuts</option>
                <option value="PENDING" {% if request.GET.status == 'PENDING' %}selected{% endif %}>En attente</option>
                <option value="COMPLETED" {% if request.GET.status == 'COMPLETED' %}selected{% endif %}>Complétés</option>
                <option value="FAILED" {% if request.GET.status == 'FAILED' %}selected{% endif %}>Échoués</option>
                <option value="REFUNDED" {% if request.GET.status == 'REFUNDED' %}selected{% endif %}>Remboursés</option>
            </select>
        </div>

        <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                <i class="fas fa-wallet"></i> Méthode
            </label>
            <select name="method" class="filter-select" onchange="this.form.submit()">
                <option value="">Toutes les méthodes</option>
                <option value="CASH" {% if request.GET.method == 'CASH' %}selected{% endif %}>Espèces</option>
                <option value="CARD" {% if request.GET.method == 'CARD' %}selected{% endif %}>Carte bancaire</option>
                <option value="BANK_TRANSFER" {% if request.GET.method == 'BANK_TRANSFER' %}selected{% endif %}>Virement</option>
                <option value="MOBILE" {% if request.GET.method == 'MOBILE' %}selected{% endif %}>Paiement mobile</option>
                <option value="CHEQUE" {% if request.GET.method == 'CHEQUE' %}selected{% endif %}>Chèque</option>
            </select>
        </div>

        {% if request.GET.status or request.GET.method %}
        <div>
            <a href="{% url 'admin_payment_list' %}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Réinitialiser
            </a>
        </div>
        {% endif %}
    </form>
</div>

<!-- Liste des paiements -->
{% if payments %}
    <div style="display: grid; gap: 1rem;">
        {% for payment in payments %}
            <div class="card" style="border-left: 4px solid {% if payment.status == 'COMPLETED' %}#10b981{% elif payment.status == 'PENDING' %}#fbbf24{% elif payment.status == 'FAILED' %}#e74c3c{% else %}#f97316{% endif %};">
                <div style="display: flex; justify-content: space-between; gap: 1.5rem; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 300px;">
                        <h3 style="margin: 0 0 0.5rem 0;">
                            <i class="fas fa-hashtag"></i>{{ payment.transaction_id }}
                        </h3>
                        <p style="color: var(--text-gray); margin-bottom: 1rem;">
                            <strong>Réservation:</strong> #{{ payment.reservation.id }} - {{ payment.reservation.event.title }}
                        </p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; font-size: 0.9rem;">
                            <div>
                                <i class="fas fa-user" style="color: var(--primary-orange);"></i>
                                <strong>Client:</strong> {{ payment.reservation.user.username }}
                            </div>
                            <div>
                                <i class="fas fa-wallet" style="color: var(--primary-orange);"></i>
                                <strong>Méthode:</strong> {{ payment.get_payment_method_display }}
                            </div>
                            <div>
                                <i class="fas fa-coins" style="color: var(--primary-orange);"></i>
                                <strong>Montant:</strong> {{ payment.amount|floatformat:3 }} TND
                            </div>
                            <div>
                                <i class="fas fa-clock" style="color: var(--primary-orange);"></i>
                                <strong>Créé:</strong> {{ payment.created_at|date:"d/m/Y H:i" }}
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end; min-width: 180px;">
                        <span class="badge" style="background: {% if payment.status == 'COMPLETED' %}#10b981{% elif payment.status == 'PENDING' %}#fbbf24{% elif payment.status == 'FAILED' %}#e74c3c{% else %}#f97316{% endif %}; color: white; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; width: 100%; text-align: center;">
                            {{ payment.get_status_display }}
                        </span>
                        
                        <a href="{% url 'payment_detail' payment.id %}" 
                           class="btn btn-primary" 
                           style="text-decoration: none; padding: 0.75rem 1rem; width: 100%; text-align: center;">
                            <i class="fas fa-eye"></i> Voir détails
                        </a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="empty-state">
        <i class="fas fa-inbox" style="font-size: 4rem; color: var(--text-gray); margin-bottom: 1rem;"></i>
        <h3>Aucun paiement trouvé</h3>
        <p>
            {% if request.GET.status or request.GET.method %}
                Aucun paiement ne correspond aux filtres sélectionnés.
            {% else %}
                Les paiements apparaissent ici lorsque les clients payent leurs factures.
            {% endif %}
        </p>
    </div>
{% endif %}

<style>
.filter-select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e2e8f0;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.3s;
}

.filter-select:focus {
    outline: none;
    border-color: var(--primary-orange);
}
</style>
{% endblock %}
